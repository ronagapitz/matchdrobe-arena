<!DOCTYPE HTML>
<html>
  <head>
    <meta charset="UTF-8"/>
    
        <script type="text/javascript" src="phonegap.js"></script>
		        <script type="text/javascript" src="childbrowser.js"></script>

		
		        <script type="text/javascript" src="js/jquery.js"></script>
    <script>
      var accessToken;
      var redirect_uri;

      function Connect()
      {

        // CHANGE HERE!
        var client_id = '493708454047333'; //YOUR App ID or API Key
        var client_secret = '3595cbac64cd4951ec2a60a2a406d7e5'; //// YOUR App Secret

        redirect_uri = 'http://www.facebook.com/connect/login_success.html';  //// YOUR CALLBACK URL
        var display = 'touch';

        var authorize_url = "https://graph.facebook.com/oauth/authorize?";
        authorize_url += "client_id=" + client_id;
          authorize_url += "&redirect_uri=" + redirect_uri;
          authorize_url += "&display=" + display;
          authorize_url += "&scope=publish_stream,offline_access";

        var cb = window.plugins.childBrowser;
        cb.showWebPage(authorize_url);
        if (cb != null)
        {
          cb.onLocationChange = function(loc)
          {
            if(loc.indexOf(redirect_uri + "?") >= 0)
            {
              var result = loc.split("#")[0];
              accessToken = result.split("&")[0].split("=")[1];

              //get access token
              var url = 'https://graph.facebook.com/oauth/access_token?';
                url += 'client_id=' + client_id;
                url += '&client_secret=' + client_secret;
                url += '&code=' + accessToken;
                url += '&redirect_uri=' + redirect_uri;

              var req = new XMLHttpRequest();
              req.open("post",url,true);
              req.send(null);
              req.onerror = function(){alert("Fail to get access token!");};
              req.onload = GetAccessToken;
              cb.close();
              location.href='#list-page';
            }
          }
        }
      }

      function GetAccessToken(evt)
      {
        var temp = evt.target.responseText.split('&')[0].split('=')[1];
        accessToken = temp;
        //get authenticated user's info
        var url = 'https://graph.facebook.com/me?fields=name,picture&access_token=' + accessToken;
        req = new XMLHttpRequest();
        req.open("get",url,true);
        req.send(null);
        req.onerror = function(){alert("Fail to get the information of the authenticated user!");};
        req.onload = GetInfo;
      }

      function GetInfo(evt)
      {
        var json = jQuery.parseJSON(evt.target.responseText);
        document.getElementById("profilePic").src=json.picture.data.url;
        document.getElementById("info").innerText=json.name;
        //get list of friends
        var url = "https://graph.facebook.com/me/friends?access_token=" + accessToken;
        var req = new XMLHttpRequest();
        req.open("get",url,true);
        req.send(null);
        req.onerror = function(){alert("Error");};
        req.onload = GetFriends;
     }

      function GetFriends(evt)
      {
        var json = jQuery.parseJSON(evt.target.responseText);
        var listItems = [];
        var template = "<li id='FBID'><img src='https://graph.facebook.com/FBID/picture'/><span>NAME</span></li>";
        len = json.data.length;
        for(var n = 0; n < len; n++)
        {
          var friendsMap = {};
          var friend = json.data[n];
          friendsMap[friend.id] = friend;
          listItems.push(template.replace(/FBID/g,friend.id).replace(/NAME/g,friend.name));
        }
        document.getElementById("fbFriends").innerHTML = listItems.join("");
      }

      function Logout()
      {
        console.log('logout');
        var url = 'https://www.facebook.com/logout.php?';
          url += 'access_token=' + accessToken;
          url += '&confirm=1&next=' +  redirect_uri;
        var req = new XMLHttpRequest();
        req.open("post",url,true);
        req.send(null);
        req.onerror = function(){alert("Fail to logout!");};
        req.onload = location.href='#connect-page';
      }
    </script>
  </head>

  <body>
    <!--Connect Screen-->
    <div data-role="page" id="connect-page">
      <div data-role="header" data-position="fixed">
        <h1>Monaca<br/>with Facebook</h1>
      </div>
      <div data-role="content" align="middle">
        <img src="images/facebook_icon.jpg" alt="Connect to Facebook" width="300">
        <input id="connect-button" type="button" value="Connect" onclick="Connect();" data-theme="b">
      </div>
    </div>

    <!--List of Friends Screen-->
    <div data-role="page" id="list-page">
      <div data-role="header">
        <h1>Monaca
        <br/>with Facebook</h1>
        <a href="#yesNoDialog" class="ui-btn-right" data-rel="popup" data-position-to="window" data-role="button" data-inline="true" data-transition="pop" data-theme="b">Logout</a>
      </div>

      <div data-role="content">
        <table border="0">
          <tr>
            <td colspan="2">
                <h3>Currently login as:</h3>
            </td>
          </tr>
          <tr align="center">
            <td>
            <img id="profilePic" src="" alt="Facebook Profile Picture">
            </td>
            <td>
              <h3 id="info"></h3>
            </td>
          </tr>
        </table>
        <hr/>
        <h3>List of Friends:</h3>
        <ul id="fbFriends">
          <!-- Display list of friends here -->
        </ul>

        <!--Dialog box confirming logout-->
        <div data-role="popup" id="yesNoDialog" data-overlay-theme="a" data-theme="c" data-dismissible="false" style="max-width:400px;" class="ui-corner-all">
          <div data-role="header" data-theme="a" class="ui-corner-top">
            <h1>Confirmation:</h1>
          </div>
          <div align="middle" data-role="content" data-theme="d" class="ui-corner-bottom ui-content">
            <h3 class="ui-title">
            <p>Are you sure you want to logout?</p>
            <a href="javascript:Logout();" data-role="button" data-inline="true" data-transition="flow" data-theme="b">Yes</a>
            <a href="#" data-role="button" data-inline="true" data-rel="back" data-transition="flow" data-theme="b">No</a>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>